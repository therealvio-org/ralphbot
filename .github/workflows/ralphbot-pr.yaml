name: Ralphbot PR Actions
on:
  pull_request:
    branches: [master]

env:
  COMMIT: ${GITHUB_SHA}
  CDK_IMAGE_NAMETAG: cdk-ralphbot
  APP_IMAGE_NAMETAG: ralphbot

jobs:
  cdk-test:
    name: ralphbot-cdk-stack-test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ops/
    steps:
      - 
        uses: actions/checkout@v3
      -
        name: Set VERSION env #Use a bash expression to define a variable for job
        run: echo "VERSION=$(date '+%Y.%m.%d'.${GITHUB_SHA::6})" >> $GITHUB_ENV
      - 
        name: "Build CDK App"
        run: |
          docker build --tag ${{ env.CDK_IMAGE_NAMETAG }}:$VERSION .
      -
        name: "Run prettier"
        run: |
          docker run -i ${{ env.CDK_IMAGE_NAMETAG }}:$VERSION prettier
      -
        name: "Run eslint"
        run: |
          docker run -i ${{ env.CDK_IMAGE_NAMETAG }}:$VERSION lint
      -
        name: "Run build"
        run: |
          docker run -i ${{ env.CDK_IMAGE_NAMETAG }}:$VERSION build
  
  #Build the Ralphbot Container Image
  ralphbot-build:
    defaults:
      run:
        working-directory: ./src/
    name: ralphbot-container-build
    runs-on: ubuntu-latest
    steps:
      - 
        uses: actions/checkout@v3
      -
        name: Set VERSION env #Use a bash expression to define a variable for job
        run: echo "VERSION=$(date '+%Y.%m.%d'.${GITHUB_SHA::6})" >> $GITHUB_ENV
      - 
        name: "Build Ralphbot Container Image"
        run: |
          docker build --tag ${{ env.APP_IMAGE_NAMETAG }}:$VERSION .